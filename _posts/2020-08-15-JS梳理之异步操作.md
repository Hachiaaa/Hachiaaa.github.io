---
layout: post
title: "JSæ¢³ç†ä¹‹å¼‚æ­¥æ“ä½œ"
date: 2020-08-15
sitemap: false
keywords: "blog"
description: "ğŸš€"
---

å¼‚æ­¥

## å¸¸è§å¼‚æ­¥æ¨¡å¼
* å›è°ƒå‡½æ•°
* äº‹ä»¶ç›‘å¬(å‘å¸ƒ/è®¢é˜…)
```javascript
class Event{
    constructor(){
        this.list={}
    }
    subscribe(key,fn){
        if(!this.list[key]){
            this.list[key]=[]
        }
        this.list[key].push(fn)
    }
    publish(key){
        let args=[].slice.call(arguments,1)
        if(!this.list[key]||this.list[key].length<=0) return false
        this.list[key].forEach(item=>{
            item.apply(this,args)
        },this)
    }

}
```
* è§‚å¯Ÿè€…æ¨¡å¼
```javascript
class Subject{
    constructor(){
        this.observers=[]
    }
    add(observer){
        this.observers.push(observer)
    }
    remove(observer){
        this.observers.splice(this.observers.indexOf(observer),1)
    }
    notify(){
        this.observers.forEach(item=>{
            item.update()
        })
    }
}

class Observer{
    constructor(name){
        this.name=name
    }
    update(){
        console.log(`fuck ${this.name}`)
    }
}

let ob1=new Observer('tom')
let ob2=new Observer('jerry')
let sub=new Subject()
sub.add(ob1)
sub.add(ob2)
sub.notify()
```

> è§‚å¯Ÿè€…æ¨¡å¼å’Œå‘å¸ƒ/è®¢é˜…æ¨¡å¼çš„åŒºåˆ«æ˜¯ï¼Œå‘å¸ƒ/è®¢é˜…æ¨¡å¼å­˜åœ¨ä¸€ä¸ªäº‹ä»¶è°ƒåº¦ä¸­å¿ƒï¼Œå¯ä»¥é’ˆå¯¹ä¸åŒçš„äº‹ä»¶æ‰§è¡Œç›¸åº”çš„æ–¹æ³•ã€‚

## å¼‚æ­¥çš„æµç¨‹æ§åˆ¶
* ä¸²è¡Œæ‰§è¡Œ
```javascript
let items='123456'.split("")
let result=[]
function async(arg,callback){
    console.log(`å‚æ•°ä¸º ï¼š${arg}`)
    setTimeout(function(){
        callback(arg*2)
    },1000)
}
function final(value){
    console.log('finished'+value)
}

function series(arg){
    if(arg){
        async(arg,function(res){
            result.push(res)
            return series(items.shift())
        })
    }else{
        return final(result[result.length-1])
    }
}

series(items.shift())
```

* å¹¶è¡Œæ‰§è¡Œ 
```javascript
let items='123456'.split("")
let result=[]
function async(arg,callback){
    console.log(`å‚æ•°ä¸º ï¼š${arg}`)
    setTimeout(function(){
        callback(arg*2)
    },1000)
}
function final(value){
    console.log('finished'+value)
}

items.forEach(item=>{
    async(item,function(arg){
        result.push(arg)
        if(result.length===items.length){
            final(result[result.length-1])
        }
    })
})
```

* ä¸²è¡Œå¹¶è¡ŒåŒæ—¶è¿ç”¨,è®¾ç½®ä¸€ä¸ªé—¨æ§›ï¼Œæ¯æ¬¡æœ€å¤šåªèƒ½å¹¶è¡Œæ‰§è¡Œnä¸ªä»»åŠ¡ã€‚

```javascript
let items='123456'.split("")
let result=[]
let running=0
let limit=2
function async(arg,callback){
    console.log(`å‚æ•°ä¸º ï¼š${arg}`)
    setTimeout(function(){
        callback(arg*2)
    },1000)
}
function final(value){
    console.log('finished'+value)
}

function run(){
    while(running<limit&&items.length>0){
        let item=items.shift()
        async(item,function(arg){
            result.push(arg)
            running--
            if(items.length>0){
                run()
            }else if(running===0){
                final(result[result.length-1])
            }
        })
        running++
    }
}
run()
```

## å®šæ—¶å™¨
* å¦‚æœå›è°ƒå‡½æ•°æ˜¯å¯¹è±¡çš„æ–¹æ³•ï¼Œé‚£ä¹ˆsetTimeoutä½¿å¾—æ–¹æ³•å†…éƒ¨çš„thiså…³é”®å­—æŒ‡å‘å…¨å±€ç¯å¢ƒï¼Œè€Œä¸æ˜¯å®šä¹‰æ—¶æ‰€åœ¨çš„é‚£ä¸ªå¯¹è±¡ã€‚
* å®šæ—¶å™¨ç¬¬äºŒä¸ªå‚æ•°ä¹‹åçš„å‚æ•°ä¼šä½œä¸ºç¬¬ä¸€ä¸ªå‡½æ•°çš„å‚æ•°ä¼ å…¥  
* setTimeoutå’ŒsetIntervalè¿”å›çš„æ•´æ•°å€¼æ˜¯è¿ç»­çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç¬¬äºŒä¸ªsetTimeoutæ–¹æ³•è¿”å›çš„æ•´æ•°å€¼ï¼Œå°†æ¯”ç¬¬ä¸€ä¸ªçš„æ•´æ•°å€¼å¤§1ã€‚
* setTimeoutå’ŒsetIntervalæŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œå¿…é¡»ç­‰åˆ°æœ¬è½®äº‹ä»¶å¾ªç¯çš„æ‰€æœ‰åŒæ­¥ä»»åŠ¡éƒ½æ‰§è¡Œå®Œï¼Œæ‰ä¼šå¼€å§‹æ‰§è¡Œã€‚ç”±äºå‰é¢çš„ä»»åŠ¡åˆ°åº•éœ€è¦å¤šå°‘æ—¶é—´æ‰§è¡Œå®Œï¼Œæ˜¯ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥æ²¡æœ‰åŠæ³•ä¿è¯ï¼ŒsetTimeoutå’ŒsetIntervalæŒ‡å®šçš„ä»»åŠ¡ï¼Œä¸€å®šä¼šæŒ‰ç…§é¢„å®šæ—¶é—´æ‰§è¡Œã€‚

## Promise

ç®€å•ç‰ˆPromiseå®ç°
```javascript
let PENDING='pending'
let RESOLVED='resolved'
let REJECTED='rejected'

function MyPromise(fn){
    let that=this
    this.value=undefined
    this.status=PENDING
    this.resolvedCb=[]
    this.rejectedCb=[]
    function resolve(value){
        setTimeout(()=>{
            if(that.status===PENDING){
                that.value=value
                that.status=RESOLVED
                that.resolvedCb.forEach(item=>{
                    item(value)
                })
            }
        },0)
    }
    function reject(reason){
        setTimeout(()=>{
            if(that.status===PENDING){
                that.value=reason
                that.status=REJECTED
                that.rejectedCb.forEach(item=>{
                    item(reason)
                })
            }
        },0)    
    }
    try{
        fn(resolve,reject)
    }catch(e){
        reject(e)
    }
}

MyPromise.prototype.then=function(onFulfilled,onRejected){
    onFulfilled=onFulfilled||(v => v)
    onRejected=onRejected||(v =>{throw v})
    if(this.status===PENDING){
        this.resolvedCb.push(onFulfilled)
        this.rejectedCb.push(onRejected)
    }else if(this.status===RESOLVED){
        onFulfilled(this.value)
    }else if(this.status===REJECTED){
        onRejected(this.value)
    }
}

new MyPromise((resolve, reject) => {
    console.log(1)
    resolve(2)
  }).then(value => {
    console.log(value)
  })
```
