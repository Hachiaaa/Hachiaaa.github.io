---
layout: post
title: "åŒºå—é“¾çš„jsåˆçº§å®ç°"
date: 2020-08-09
sitemap: false
keywords: "blog"
description: "ğŸš€"
---

ç”¨ JS æ¥è§£é‡ŠåŒºå—é“¾

> åŒºå—é“¾ç”±ä¸€ä¸ªä¸ªåŒºå—æ„æˆï¼Œæ¯ä¸ªåŒºå—å­˜å‚¨æ•°æ®ï¼Œhash æŒ‡çº¹ï¼Œå‰ä¸€ä¸ªåŒºå—çš„ hash æŒ‡çº¹ã€‚ä¸ºäº†ä¿è¯åŒºå—é“¾ä¸­ä¸è¢«éšä¾¿æ·»åŠ åŒºå—ï¼ŒæŒ‡å®šäº† hash æŒ‡çº¹çš„å‰ N ä½æ•°å­—å¿…é¡»ä¸º 0ï¼ŒN è¡¨ç¤ºéš¾åº¦ï¼Œæ‰€ä»¥åŒºå—è¿˜éœ€è¦æœ‰ä¸€ä¸ª nonce++å€¼æ¥è®¡ç®— hash ç›´åˆ°ç¬¦åˆè¦æ±‚ã€‚

> åŒºå—é“¾çš„æ·»åŠ åŒºå—æ“ä½œï¼Œå…¶å®å°±æ˜¯æŒ–çŸ¿(proof of work æœºåˆ¶)ã€‚æŒ–çŸ¿æˆåŠŸï¼Œå®˜æ–¹ä¼šç»™åˆ°å¥–åŠ±ã€‚

```javascript
//å¼•å…¥hashç®—æ³•
const sha256=require('crypto-js/sha256')

//å®šä¹‰åŒºå—ç±»
class Block{
    constructor(transaction,previousHash){
        //transactionå°±æ˜¯åŒºå—é‡Œçš„æ•°æ®,ä¸€èˆ¬æ˜¯æ•°ç»„ï¼Œè¿™é‡Œå­—ç¬¦ä¸²åŒ–
        this.transaction=JSON.stringify(transaction)
        this.previousHash=previousHash
        //æŒ–çŸ¿çš„å¾ªç¯è°ƒæ•´å€¼
        this.nonce=0
        this.hash=this.computeHash()
    }
    computeHash(){
        return sha256(this.transaction+this.previousHash+this.nonce).toString()
    }
    //æŒ–çŸ¿è®¡ç®—hash
    mine(difficulty){
        while(this.hash.substring(0,difficulty)!==new Array(difficulty).fill('0').join("")){
            this.nonce++
            this.hash=this.computeHash()
        }
        console.log('mine successfully',this.hash)
        console.log(`you have tried ${this.nonce} times`)
    }
}

//å®šä¹‰äº¤æ˜“ä¿¡æ¯ï¼Œè¿”å›ä¸€ä¸ªå¯¹è±¡
class Transaction{
    constructor(fromAddress,toAddress,amount){
        this.fromAddress=fromAddress
        this.toAddress=toAddress
        this.amount=amount
    }
}

//å®šä¹‰åŒºå—é“¾
class BlockChain{
    constructor(){
        //æ•´ä¸ªé“¾ç”¨ä¸€ä¸ªæ•°ç»„æ¨¡æ‹Ÿï¼Œå¤´éƒ¨ä¸ºä¸€ä¸ªç¥–å…ˆåŒºå—
        this.chain=[this.createAncestor()]
        //æŒ–çŸ¿éš¾åº¦ï¼Œå³hashå‰é¢0çš„ä¸ªæ•°
        this.difficulty=4
        //ä¸‹æ¬¡æŒ–çŸ¿çš„è½¬è´¦ä¿¡æ¯
        this.pendingTransactions=[]
        //çŸ¿å·¥å¥–åŠ±
        this.miningReward=100
    }

    createAncestor(){
        return new Block('ancestor','ancestorhash')
    }

    getLatestBlock(){
        return this.chain[this.chain.length-1]
    }

    //æ·»åŠ è½¬è´¦ä¿¡æ¯
    createTransaction(transaction){
        this.pendingTransactions.push(transaction)
    }

    //æŒ–çŸ¿ï¼Œæ·»åŠ åŒºå—
    minePendingTransactions(miningRewardAddress){
        console.time('total time')
        let block=new Block(this.pendingTransactions)
        block.previousHash=this.getLatestBlock().hash
        block.mine(this.difficulty)
        this.chain.push(block)
        console.timeEnd('total time')
        //æŒ–çŸ¿ç»“æŸåç”±å®˜æ–¹å¥–åŠ±ï¼Œè½¬è´¦ä¿¡æ¯æ¨å…¥åˆ°ä¸‹æ¬¡æŒ–çŸ¿çš„è½¬è´¦ä¿¡æ¯ä¸­ï¼Œä¸‹ä¸€æ¬¡åŒºå—è¢«æ·»åŠ åå¯ä»¥è·å¾—å¥–åŠ±
        this.pendingTransactions=[
            new Transaction('OFFICIAL',miningRewardAddress,this.miningReward)
        ]
    }

    //è®¡ç®—æŸä¸ªè´¦æˆ·çš„ä½™é¢
    getBalanceOfAddress(address){
        let balance=0
        for(let block of this.chain){
            for(let trans of block.transaction){
                if(trans.fromAddress===address) balance-=trans.amount
                if(trans.toAddress===address) balance+=trans.amount
            }
        }
        return balance
    }

    //éªŒè¯åŒºå—é“¾æ˜¯å¦æœ‰æ•ˆï¼ŒåŒ…æ‹¬äº¤æ˜“ä¿¡æ¯ç¯¡æ”¹ï¼Œä»¥åŠåŒºå—é“¾æ˜¯å¦æ–­è£‚
    isValid(){
        let len=this.chain.length
        for(let i=1;i<len;i++){
            let previousBlock=this.chain[i-1]
            let currentBlock=this.chain[i]
            if(currentBlock.previousHash!==previousBlock.hash){
                console.log('block chain is broken')
                return false
            }
            if(currentBlock.hash!==currentBlock.computeHash()){
                console.log('data has been modified')
                return false
            }
        }
        return true
    }
    print(){
        console.log(this.chain)
        if(this.isValid()){
            console.log('valid block chain')
        }else{
            console.log('invalid block chain')
        }
    }
}

//æµ‹è¯•

onst chain=new BlockChain()
//åˆ›å»ºäº¤æ˜“
chain.createTransaction(new Transaction('address1','address2',100))
chain.createTransaction(new Transaction('address2','address1',50))

//å¼€å§‹æŒ–çŸ¿ï¼Œå¥–åŠ±åˆ°è´¦æˆ·hachi
chain.minePendingTransactions('hachi')

chain.print()
```
