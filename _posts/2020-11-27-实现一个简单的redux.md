---
layout: post
title: "å®žçŽ°ä¸€ä¸ªç®€å•çš„redux"
date: 2020-11-27
sitemap: false
keywords: "blog"
description: "ðŸš€"
---

reduxæ ¸å¿ƒåŽŸç†è§£æž

```javascript
//createStoreå‡½æ•°æŽ¥å—reducerï¼Œåˆå§‹çŠ¶æ€ï¼Œä¸­é—´ä»¶
function createStore(reducer,initState,rewriteCreateStore){
    if(typeof initState==='function'){
        rewriteCreateStore=initState
        initState=undefined
    }
	if(rewriteCreateStore){
		let newCreateStore=rewriteCreateStore(createStore)
		return newCreateStore(reducer,initState)
	}
	let state=initState 
	let listeners=[]
	function subscribe(fn){
		listeners.push(fn)
	}
	function getState(){
		return state
	}
	function dispatch(action){
		state=reducer(state,action)
		listeners.forEach(item=>{
			item()
		})
	}
	dispatch({type:Symbol()})
	return {
		getState,
		subscribe,
		dispatch
	}
}

let countInitState={
	count:1
}

function countReducer(state,action){
	if(!state){
		state=countInitState
	}
	switch(action.type){
		case 'increment':
			return{
				...state,
				count:state.count+action.num
			}
		case 'decreament':
			return{
				...state,
				count:state.count-action.num
			}
		default:
			return state
	}
}

let infoInitState={
	name:'cheong kwan jang',
	desc:'korean red ginseng'
}

function infoReducer(state,action){
	if(!state){
		state=infoInitState
	}
	switch(action.type){
		case 'setName':
			return{
				...state,
				name:action.name
			}
		case 'setDesc':
			return{
				...state,
				desc:action.desc
			}
		default:
			return state
	}
}

function combineReducers(reducers){
	let reducerkey=Object.keys(reducers)
	return function(state={},action){
		const nextState={}
		reducerkey.forEach((item,index)=>{
			let singleState=reducers[item](state[item],action)
			nextState[item]=singleState
		})
		return nextState
	}
}


let state={
	counter:{
		count:1
	},
	info:{
		name:'cheongkwanjang',
		desc:'korean red ginseng'
	}
}

let reducer=combineReducers({
	counter:countReducer,
	info:infoReducer
})

//æ—¥å¿—è®°å½•ä¸­é—´ä»¶
let loggerMiddleware=(store)=>(next)=>(action)=>{
	console.log('oldstate',store.getState())
	console.log('action',action.type)
	next(action)
	console.log('newstate',store.getState())
}

//æ—¶é—´ä¸­é—´ä»¶
let timeMiddleware=(store)=>(next)=>(action)=>{
	console.log('time right now',new Date().toLocaleString())
	next(action)
}

//thunkä¸­é—´ä»¶ï¼Œå…è®¸æˆ‘ä»¬dispatchä¸€ä¸ªå‡½æ•°ï¼Œåœ¨å‡½æ•°ä¸­é—´å¯ä»¥åŒæ—¶å‘èµ·å¤šä¸ªaction

let thunkMiddleware=(store)=>(next)=>(action)=>{
    if(typeof action ==='function'){
        let {dispatch}=store
        action(dispatch)
    }
    next(action)
}


function applyMiddlewares(...middlewares){
	function compose(...fns){
		if(fns.length===1){
			return fns[0]
		}else{
			return fns.reduce((a,b)=>((...args)=>a(b(...args))))
		}

	}
	return function(oldcreatestore){
		return function newCreateStore(reducer,initState){
			let store=oldcreatestore(reducer,initState)
			let chain=middlewares.map(item=>item(store))
			store.dispatch=compose(...chain)(store.dispatch)
			return store
		}
	}
}

let newCreateStore=applyMiddlewares(timeMiddleware,loggerMiddleware)

let store=createStore(reducer,newCreateStore)

store.subscribe(()=>{
	console.log(store.getState())
})

store.dispatch({
	type:'setName',
	name:'haha'
})
```