---
layout: post
title: "å¦‚ä½•å†™ä¸€ä¸ªå®Œæ•´çš„promise"
date: 2020-09-21
sitemap: false
keywords: "blog"
description: "ðŸš€"
---

ç¬¦åˆPromise A+è§„èŒƒçš„promiseå®žçŽ°

> é¦–å…ˆpromiseçš„æ‰§è¡Œé¡ºåºæ˜¯thenæ”¶é›†ä¾èµ–-->å¼‚æ­¥è§¦å‘resolve-->resolveæ‰§è¡Œä¾èµ–  
> Promiseæœ¬è´¨æ˜¯ä¸€ä¸ªçŠ¶æ€æœºï¼ŒåŒ…å«pendingï¼Œresolvedï¼Œrejectedä¸‰ç§çŠ¶æ€ã€‚ä¸”çŠ¶æ€çš„å˜åŒ–åªèƒ½ä»Žpendingåˆ°resolvedæˆ–è€…rejectedï¼Œå³çŠ¶æ€æ˜¯å•å‘å˜åŒ–çš„  
> thençš„é“¾å¼è°ƒç”¨ï¼Œè¿”å›žä¸€å±‚promiseå¤„ç†ï¼Œå¹¶åˆ¤æ–­thenå›žè°ƒå‡½æ•°çš„è¿”å›žç±»åž‹  
> å€¼ç©¿é€å¤„ç†ï¼Œå¦‚æžœthençš„å‚æ•°ä¸æ˜¯functionï¼Œåº”è¯¥å¿½ç•¥ï¼Œå¦åˆ™é“¾å¼è°ƒç”¨ä¼šä¸­æ–­
> å¯¹äºŽçŠ¶æ€å·²ç»ä¸ºresolved,rejectedçš„æƒ…å†µï¼Œç›´æŽ¥æ‰§è¡Œthenæ–¹æ³•çš„å›žè°ƒ

```javascript
//é¦–å…ˆå®šä¹‰ä¸‰ç§çŠ¶æ€
const PENDING='PENDING'
const RESOLVED='RESOLVED'
const REJECTED='REJECTED'

class MyPromise{
    constructor(excutor){
        this.resolvedQueen=[] //æˆåŠŸå›žè°ƒé˜Ÿåˆ—
        this.rejectedQueen=[] //å¤±è´¥å›žè°ƒé˜Ÿåˆ—
        this._value=undefined  //å‚¨å­˜thenå›žè°ƒçš„å‚æ•°
        this.status=PENDING
        let _resolve=(val)=>{
            //æ³¨æ„è¿™é‡Œä¸ºäº†å¤„ç†resolveä¸ºåŒæ­¥çš„æƒ…å†µï¼Œå¯¹resolveçš„æ‰§è¡Œç”¨å®ä»»åŠ¡æ¨¡æ‹Ÿï¼Œä¿è¯thenå›žè°ƒå…ˆè¢«æŽ¨å…¥åˆ°å›žè°ƒé˜Ÿåˆ—ä¸­

            const run=()=>{
                if(this.status!==PENDING) return
                this.status=RESOLVED
                this._value=val
                while(this.resolvedQueen.length){
                    let cb=this.resolvedQueen.shift()
                    cb(val)
                }
            }
            setTimeout(run)         
        }
        let _reject=(val)=>{
            const run=()=>{
                if(this.status!==PENDING) return
                this.status=REJECTED
                this._value=val
                while(this.rejectedQueen.length){
                    let cb=this.rejectedQueen.shift()
                    cb(val)
                }
            }
            setTimeout(run)
        }     
        excutor(_resolve,_reject)
    }
    then(fulfilledFn,rejectedFn){
        //å€¼ç©¿é€
        typeof fulfilledFn !== 'function' ? fulfilledFn = value => value : null
        typeof rejectedFn !== 'function' ? rejectedFn = reason => {
         throw new Error(reason instanceof Error? reason.message:reason);
        } : null
        return new MyPromise((resolve,reject)=>{
            const newFulfilldFn=(val)=>{
                try{
                    let x=fulfilledFn(val)
                    //ä½œå€¼çš„åˆ¤æ–­ï¼Œå¦‚æžœæ˜¯Promiseç›´æŽ¥å¥—ä¸€å±‚then,å¦åˆ™ç›´æŽ¥resolveæŠ›å‡º
                    x instanceof MyPromise?x.then(resolve,reject):resolve(x)
                }catch(err){
                    reject(err)
                }
            }
            
            const newRejectedFn=(val)=>{
                try{
                    let x=rejectedFn(val)
                    x instanceof MyPromise?x.then(resolve,reject):resolve(x)
                }catch(err){
                    reject(err)
                }
            }
            //å¤„ç†çŠ¶æ€ä¸ºresolvedå’Œrejectedçš„æƒ…å†µ
            switch(this.status){
                case PENDING:
                    this.resolvedQueen.push(newFulfilldFn)
                    this.rejectedQueen.push(newRejectedFn)
                    break
                case RESOLVED:
                    fulfilledFn(this._value)
                    break
                case REJECTED:
                    rejectedFn(this._value)
                    break
            }
        })
    }
    //catchå°±æ˜¯thençš„è¯­æ³•ç³–
    catch(rejectFn){
        return this.then(undefined,rejectFn)
    }

    static resolve(value){
        // æ ¹æ®è§„èŒƒ, å¦‚æžœå‚æ•°æ˜¯Promiseå®žä¾‹, ç›´æŽ¥returnè¿™ä¸ªå®žä¾‹
        if(value instanceof MyPromise) return value 
        return new MyPromise(resolve => resolve(value))
    }
    static reject(reason){
        return new MyPromise((resolve,reject)=>reject(reason))
    }

    static all(promiseArr){
        let result=[]
        let index=0
        return new MyPromise((resolve,reject)=>{
            promiseArr.forEach((promise,i)=>{
                //resolveå¤„ç†ä¼ å…¥å€¼ä¸ä¸ºpromiseçš„æƒ…å†µ
                MyPromise.resolve(promise).then(
                    val=>{
                    index++
                    result[i]=val
                    if(index===promiseArr.length) resolve(result)    
                },
                err=>reject(err))
            })
        })
    }

    static race(promiseArr){
        return new MyPromise((resolve,reject)=>{
            promiseArr.forEach((promise,i)=>{
                //resolveå¤„ç†ä¼ å…¥å€¼ä¸ä¸ºPromiseçš„æƒ…å†µ
                MyPromise.resolve(promise).then(
                    val=>resolve(val),
                    err=>reject(err)
                    )
            })
        })
    }
}

//æµ‹è¯•
const p1 = new MyPromise((resolve, reject) => {
    resolve(1)          //åŒæ­¥executoræµ‹è¯•
  })
  
p1.then(res => {
      console.log(res)
      return 2          //é“¾å¼è°ƒç”¨æµ‹è¯•
    })
    .then()             //å€¼ç©¿é€æµ‹è¯•
    .then(res => {
      console.log(res)
      return new MyPromise((resolve, reject) => {
        setTimeout(()=>resolve(3),500)     //è¿”å›žPromiseæµ‹è¯•
      })
    })
    .then(res => {
      console.log(res)
      throw new Error('rejectæµ‹è¯•')   //rejectæµ‹è¯•
    })
    .then(null,err=>console.log(err))

```